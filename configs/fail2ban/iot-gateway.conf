# Fail2ban filter for the IoT Auth Gateway structured JSON audit log.
#
# Matches log lines where "success":false and "remote_addr" is present.
# The gateway writes one JSON object per line, e.g.:
#
#   {"timestamp":"2025-01-01T00:00:00Z","event":"AUTH_FAILURE",
#    "remote_addr":"1.2.3.4","cert_serial":"","message":"no client certificate","success":false}
#
# Install to: /etc/fail2ban/filter.d/iot-gateway.conf

[Definition]

# Extract the IP from the "remote_addr" field of a JSON audit record.
# We only match lines that contain "success":false to avoid false positives.
failregex = ^.*"remote_addr"\s*:\s*"<HOST>".*"success"\s*:\s*false.*$

ignoreregex =

# Hint to Fail2ban about the log date format (ISO-8601 in "timestamp" field).
# Fail2ban's default ISO-8601 parser handles this correctly.
datepattern = %%Y-%%m-%%dT%%H:%%M:%%S
